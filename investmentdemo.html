<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feasibility Mini ‚Äî IRR & Payback (v3.6 ‚Ä¢ Regex/CSV fix + More tests)</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--text:#0b1220;--muted:#55657a;--grid:#e3eaf5;--accent:#0b74ff;--good:#0b9b6b;--bad:#d64545;--warn:#b58100}
    *{box-sizing:border-box;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:28px auto;padding:0 14px}
    h1{font-size:20px;margin:0 0 10px}
    .card{background:var(--card);border:1px solid var(--grid);border-radius:14px;box-shadow:0 8px 20px rgba(15,25,40,.05);margin:10px 0}
    .hd{padding:14px 16px;border-bottom:1px solid var(--grid);font-weight:700;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .bd{padding:14px 16px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input,select,button{font-size:14px}
    input,select{width:100%;padding:10px 12px;border:1px solid #cbd7e6;border-radius:10px;background:#fff;color:var(--text)}
    input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(11,116,255,.12)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .pill{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill label{display:flex;align-items:center;gap:6px;margin:0;color:var(--text)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#eef5ff;border:1px solid #cfe0ff;color:#0b2a66;padding:9px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;color:#55657a;border-color:var(--grid)}
    .btn.line{background:transparent;color:#0b2a66;border-color:#cfe0ff}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .box{background:#fff;border:1px solid var(--grid);border-radius:12px;padding:12px;position:relative}
    .sub{font-size:12px;color:var(--muted)}
    .val{font-size:22px;font-weight:800;margin-top:6px}
    .val.good{color:var(--good)}.val.bad{color:var(--bad)}
    .small{font-size:12px;color:#6a7b90;margin-top:4px}
    table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:10px}
    th,td{padding:8px 10px;text-align:left}
    th{font-size:12px;color:#6a7b90}
    tr{background:#fff;border:1px solid var(--grid)}
    tr td:first-child{border-radius:8px 0 0 8px}
    tr td:last-child{border-radius:0 8px 8px 0}
    .right{text-align:right}
    .note{font-size:12px;color:#6a7b90;margin-top:8px}
    .wizard{margin-top:10px;border:1px dashed #cfe0ff;border-radius:12px;background:#f4f8ff;padding:12px}
    .wizard .row{grid-template-columns:2fr 1fr 1fr}
    .mini{font-size:12px;color:#6a7b90}
    .lamp{position:absolute;top:12px;right:12px;display:inline-flex;gap:6px;align-items:center;font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--grid);}
    .pass{background:#eefaf4;border-color:#bde5cf;color:#0b6b49}
    .fail{background:#fff0f0;border-color:#ffd3d3;color:#a33a3a}
    canvas{display:none}
    pre{background:#0b1220;color:#e7edf5;padding:10px;border-radius:10px;overflow:auto}
    .errbar{position:sticky;top:0;z-index:50;background:#fff0f0;border:1px solid #ffd3d3;color:#a33a3a;padding:8px 12px;border-radius:10px;margin:10px 0;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìà Feasibility Mini ‚Äî IRR & Payback (v3.6)</h1>

    <div id="errbar" class="errbar"></div>

    <div class="card">
      <div class="hd">Inputs (Minimal)</div>
      <div class="bd">
        <div class="row">
          <div>
            <label>Currency (label only)</label>
            <input id="cur" value="SAR"/>
          </div>
          <div>
            <label>Horizon (years)</label>
            <input id="years" type="number" value="6" min="1" max="50"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Total Budget (CAPEX, negative)</label>
            <input id="budget" type="number" value="-1000000"/>
          </div>
          <div>
            <label>Execution length</label>
            <div class="row">
              <select id="durUnit"><option value="months" selected>Months</option><option value="years">Years</option></select>
              <input id="durVal" type="number" value="12" min="1"/>
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Steady-state annual net benefit (after OPEX)</label>
            <input id="benefit" type="number" value="400000"/>
            <div class="mini">Use the wizard to compute this automatically.</div>
          </div>
          <div>
            <label>NPV discount (%)</label>
            <input id="disc" type="number" value="10"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>IRR hurdle (%)</label>
            <input id="hurdle" type="number" value="50"/>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="pill"><span class="sub">Structure:</span>
              <label><input type="radio" name="mode" value="full" checked> Full</label>
              <label><input type="radio" name="mode" value="phased"> Phased</label>
              <button class="btn ghost" id="toggleWizard" style="margin-left:auto">Benefit Wizard</button>
            </div>
          </div>
        </div>

        <!-- Benefit Wizard -->
        <div id="wizard" class="wizard" style="display:none">
          <div class="mini" style="margin-bottom:8px">Compute: <b>Net benefit = Revenue uplift + Cost savings ‚àí ŒîOPEX</b> (annual, steady-state).</div>

          <div class="row">
            <div>
              <label>Time savings ‚Äî priced hours/year</label>
              <input id="w_hours" type="number" placeholder="e.g., 6500"/>
            </div>
            <div>
              <label>Value per hour</label>
              <input id="w_hourRate" type="number" placeholder="e.g., 346"/>
            </div>
            <div>
              <label>Subtotal</label>
              <input id="w_hours_sum" type="number" disabled />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Incident response ‚Äî minutes saved √ó events/year</label>
              <input id="w_inc_events" type="number" placeholder="e.g., 24"/>
            </div>
            <div>
              <label>Minutes saved √ó cost/min</label>
              <input id="w_inc_minCost" type="number" placeholder="e.g., 8√ó1000 ‚Üí 8000"/>
            </div>
            <div>
              <label>Subtotal</label>
              <input id="w_inc_sum" type="number" disabled />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Energy/consumables savings (annual)</label>
              <input id="w_energy" type="number" placeholder="e.g., 120000"/>
            </div>
            <div>
              <label>Other direct savings (annual)</label>
              <input id="w_other" type="number" placeholder="e.g., 50000"/>
            </div>
            <div>
              <label>Subtotal</label>
              <input id="w_dir_sum" type="number" disabled />
            </div>
          </div>

          <div class="row">
            <div>
              <label>ŒîOPEX (extra ops cost: energy, maintenance, labor)</label>
              <input id="w_opex" type="number" placeholder="e.g., 250000"/>
            </div>
            <div>
              <label>Gross benefit (auto)</label>
              <input id="w_gross" type="number" disabled />
            </div>
            <div>
              <label>Net benefit (gross ‚àí ŒîOPEX)</label>
              <input id="w_net" type="number" disabled />
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
            <button class="btn" id="applyWizard">Use net benefit above</button>
            <button class="btn ghost" id="loadSample">Load Rahaf example</button>
            <div class="mini" id="wizardNote"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="phasedCard" style="display:none">
      <div class="hd">Phased Execution (Sequential)</div>
      <div class="bd">
        <div class="row3">
          <button class="btn" id="addPhase">+ Add phase</button>
          <button class="btn ghost" id="resetPhases">Reset</button>
        </div>
        <table id="phTable" style="display:none">
          <thead><tr><th>#</th><th>Cost (‚àí)</th><th>Duration (months)</th><th>Auto start (month)</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="note">Default: phases run back‚Äëto‚Äëback. Benefit ramps up proportional to phase cost share. You can edit costs/durations only.</div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <span>Cashflows (auto)</span>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn line" id="exportCsv">Export CSV</button>
          <button class="btn line" id="exportPng">Export PNG KPIs</button>
        </div>
      </div>
      <div class="bd">
        <button class="btn" id="build">Build cashflows</button>
        <button class="btn ghost" id="calc">Calculate IRR & Payback</button>
        <div id="flows"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">Results</div>
      <div class="bd" id="kpiCard">
        <div class="kpi">
          <div class="box"><div class="sub">IRR</div><div class="val" id="irr">‚Äî</div><div id="lamp" class="lamp fail" style="display:none">‚óè <span id="lampText">Below hurdle</span></div></div>
          <div class="box"><div class="sub">Payback</div><div class="val" id="pb">‚Äî</div><div class="small" id="pbMonths"></div></div>
          <div class="box"><div class="sub">NPV</div><div class="val" id="npv">‚Äî</div></div>
        </div>
        <div class="note" id="warn" style="display:none;margin-top:8px"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">Tests (built-in)</div>
      <div class="bd">
        <button class="btn" id="runTests">Run tests</button>
        <pre id="testOut">(no tests run yet)</pre>
      </div>
    </div>

    <div class="mini" style="text-align:center;margin-top:8px;opacity:.7">Engineered by Rahaf</div>

    <canvas id="snapCanvas" width="1200" height="420"></canvas>
  </div>

<script>
'use strict';
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const phTBody = () => $('#phTable tbody');

function showErr(msg){ const bar=$('#errbar'); if(!bar) return; bar.style.display='block'; bar.textContent='Error: '+msg; }
window.addEventListener('error',(e)=>showErr(e.message||e.type));
window.addEventListener('unhandledrejection',(e)=>showErr(e.reason?.message||String(e.reason)));

function monthsFromUnit(){ const u=$('#durUnit').value; const v=Math.max(1,parseInt($('#durVal').value||1)); return u==='years'? v*12 : v; }

let phaseList=[];
function initPh(){ const t=phTBody(); if(!t) return; $('#phTable').style.display='none'; t.innerHTML=''; phaseList=[]; }
function addPhase(){ const tbl=$('#phTable'); if(tbl && tbl.style.display==='none') tbl.style.display='table'; const n=phaseList.length; const start = phaseList.reduce((s,p)=>s+p.dur,0)+1; const budget=parseFloat($('#budget').value||0)||0; const cost = n===0? Math.round(budget*0.6): Math.round(budget*(n===1?0.3:0.1)); const dur = n===0? Math.min(6, monthsFromUnit()): Math.min(4, Math.max(1, monthsFromUnit()-phaseList.reduce((s,p)=>s+p.dur,0)) ); const row={idx:n+1, cost:cost, dur:dur, start:start}; phaseList.push(row); renderPhTable(); }
function renderPhTable(){ const t=phTBody(); if(!t) return; t.innerHTML=''; let start=1; phaseList.forEach((p,i)=>{ p.start=start; start+=p.dur; const tr=document.createElement('tr'); tr.innerHTML='<td>'+(i+1)+'</td>'+
  '<td><input type="number" value="'+p.cost+'" data-i="'+i+'" data-k="cost"/></td>'+
  '<td><input type="number" value="'+p.dur+'" data-i="'+i+'" data-k="dur"/></td>'+
  '<td>'+p.start+'</td>'; t.appendChild(tr); });
  t.querySelectorAll('input').forEach(inp=>{ inp.addEventListener('input',()=>{ const i=parseInt(inp.dataset.i), k=inp.dataset.k; const v=inp.value; if(k==='dur'){ phaseList[i][k]=Math.max(1, parseInt(v||1)); } else { phaseList[i][k]=parseFloat(v||0); } renderPhTable(); }); });
}

function buildCashflows(){ const years=parseInt($('#years').value||6); const months=years*12; const budget=parseFloat($('#budget').value||0); const benefitYear=parseFloat($('#benefit').value||0); const mode=(document.querySelector('input[name="mode"]:checked')||{value:'full'}).value; const capexM=new Array(months).fill(0); const benM=new Array(months).fill(0);
  if(mode==='full'){ const dur=monthsFromUnit(); const per = (dur>0? budget/dur: budget); for(let m=0;m<dur && m<months;m++){ capexM[m]+=per; } for(let m=dur;m<months;m++){ benM[m]+= (benefitYear/12); } }
  else { if(phaseList.length===0) addPhase(); const totalAbs = Math.abs(phaseList.reduce((s,p)=>s+p.cost,0)) || Math.abs(budget)||1; phaseList.forEach(p=>{ const per = p.dur>0? p.cost/p.dur : p.cost; for(let m=p.start-1; m<p.start-1+p.dur && m<months; m++){ capexM[m]+=per; } const share = Math.abs(p.cost)/totalAbs; const phaseYear = benefitYear*share; const live = (p.start-1+p.dur); for(let m=live; m<months; m++){ benM[m]+= (phaseYear/12); } }); }
  const cfs=[0]; for(let y=1;y<=years;y++){ const s=(y-1)*12, e=y*12-1; let cap=0, ben=0; for(let m=s;m<=e && m<months;m++){ cap+=capexM[m]; ben+=benM[m]; } cfs.push(cap+ben); }
  renderFlows(cfs); return cfs; }

function renderFlows(cfs){ const cur=$('#cur')?.value||''; let html='<table><thead><tr><th>Year</th><th class="right">Cash flow</th><th class="right">Cumulative</th></tr></thead><tbody>'; let cum=0; html+=row(0,0,0); for(let i=1;i<cfs.length;i++){ cum+=cfs[i]; html+=row(i,cfs[i],cum); } html+='</tbody></table>'; const flows=$('#flows'); if(flows) flows.innerHTML=html; function row(y,v,c){ return '<tr><td>Y'+y+'</td><td class="right">'+fmt(v)+' '+cur+'</td><td class="right">'+fmt(c)+' '+cur+'</td></tr>'; } }

function NPV(r,c){ let s=0; for(let t=0;t<c.length;t++){ s+= c[t]/Math.pow(1+r,t);} return s; }
function IRR(c){ const pos=c.some(v=>v>0), neg=c.some(v=>v<0); if(!pos||!neg) return NaN; let x0=0.1,x1=0.2,f0=NPV(x0,c),f1=NPV(x1,c); for(let i=0;i<50;i++){ if(Math.abs(f1-f0)<1e-12) break; const x2=x1 - f1*(x1-x0)/(f1-f0); if(!isFinite(x2)||x2<=-0.9999||x2>10) break; x0=x1;f0=f1;x1=x2;f1=NPV(x1,c); if(Math.abs(f1)<1e-7) return x1; } let lo=-0.9,hi=10,flo=NPV(lo,c),fhi=NPV(hi,c); if(flo*fhi>0){ lo=-0.99;hi=20;flo=NPV(lo,c);fhi=NPV(hi,c); if(flo*fhi>0) return NaN; } for(let i=0;i<200;i++){ const mid=(lo+hi)/2, fm=NPV(mid,c); if(Math.abs(fm)<1e-7) return mid; if(flo*fm<0){ hi=mid; fhi=fm; } else { lo=mid; flo=fm; } } return (lo+hi)/2; }
function payback(c){ let cum=0; for(let t=0;t<c.length;t++){ const prev=cum; cum+=c[t]; if(cum>=0){ if(t===0) return {yrs:0, mos:0}; const need=-prev; const frac = c[t]!==0? need/c[t]:1; const years=(t-1)+Math.min(Math.max(frac,0),1); const months=Math.round(years*12); return {yrs:years, mos:months}; } } return {yrs:Infinity, mos:Infinity}; }
function fmt(n){ return new Intl.NumberFormat('en-US',{maximumFractionDigits:0}).format(n||0); }
function pct(x){ return isFinite(x)? (x*100).toFixed(2)+'%':'‚Äî'; }

// CSV helper (safe newlines + quoting)
function buildCsvString(meta, rows){
  function esc(v){
    const s=String(v==null? '': v);
    if(/[",\n]/.test(s)) return '"'+s.replace(/"/g,'""')+'"';
    return s;
  }
  let csv='';
  csv += '# Parameters\n';
  meta.forEach(r=>{ csv += esc(r[0])+','+esc(r[1])+'\n'; });
  csv += '\n# Cashflows\n';
  rows.forEach(r=>{ csv += r.map(esc).join(',')+'\n'; });
  return csv;
}

function snapshotDataURL(){ const cfs=buildCashflows(); cfs[0]=parseFloat($('#budget').value||0); const disc=(parseFloat($('#disc').value)||0)/100; const r=IRR(cfs); const pb=payback(cfs); const npv=NPV(disc,cfs); const irrTxt = isFinite(r)? (r*100).toFixed(2)+'%':'No IRR'; const pbTxt = (pb.yrs===Infinity)? 'Not recovered' : pb.yrs.toFixed(2)+' yrs'; const pbMos = (pb.mos===Infinity)? '' : ' ('+pb.mos+' months)'; const npvTxt = fmt(npv)+' '+($('#cur').value||''); const hurdle = parseFloat($('#hurdle').value||0); const pass = isFinite(r) && (r*100)>=hurdle; const canvas=$('#snapCanvas'); const dpr=window.devicePixelRatio||1; const W=1200,H=420; canvas.width=W*dpr; canvas.height=H*dpr; canvas.style.width=W+'px'; canvas.style.height=H+'px'; const ctx=canvas.getContext('2d'); ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#0b1220'; ctx.font='700 20px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto'; ctx.fillText('Feasibility KPIs Snapshot',24,36); ctx.font='400 12px ui-sans-serif'; const ts=new Date().toLocaleString(); ctx.fillStyle='#55657a'; ctx.fillText('Generated: '+ts,24,56); function rrect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); } function card(x,y,w,h,title,value,small,accent){ ctx.fillStyle='#ffffff'; rrect(x,y,w,h,14); ctx.fill(); ctx.strokeStyle='#e3eaf5'; ctx.lineWidth=1; ctx.stroke(); ctx.fillStyle='#55657a'; ctx.font='700 12px ui-sans-serif'; ctx.fillText(title,x+16,y+26); ctx.fillStyle=accent; ctx.font='800 28px ui-sans-serif'; ctx.fillText(value,x+16,y+62); if(small){ ctx.fillStyle='#6a7b90'; ctx.font='12px ui-sans-serif'; ctx.fillText(small,x+16,y+86); } } const good='#0b9b6b', bad='#d64545'; card(24,100,360,120,'IRR', irrTxt, pass? 'Meets hurdle '+hurdle+'%' : 'Below hurdle '+hurdle+'%', pass? good:bad); card(420,100,360,120,'Payback', pbTxt, pbMos, '#0b74ff'); card(816,100,360,120,'NPV', npvTxt, '@ '+($('#disc').value||'')+'% discount', (npv>0? good:bad)); ctx.fillStyle='#f7f9fc'; rrect(24,250,1152,120,12); ctx.fill(); ctx.strokeStyle='#e3eaf5'; ctx.stroke(); ctx.fillStyle='#55657a'; ctx.font='12px ui-sans-serif'; const meta=['Currency: '+($('#cur').value||''),'Horizon: '+($('#years').value||'')+' yrs','Budget: '+($('#budget').value||''),'Exec: '+($('#durVal').value||'')+' '+($('#durUnit').value||''),'Benefit/yr: '+($('#benefit').value||'')]; meta.forEach((t,i)=>{ ctx.fillText(t,40+i*220,280); }); return canvas.toDataURL('image/png'); }

function bindUI(){ function on(sel,ev,fn){ const el=$(sel); if(!el){ console.warn('Missing element for',sel); return; } el.addEventListener(ev,fn); }
  on('input[name="mode"][value="full"]','change',()=>{ const ph=$('#phasedCard'); if(ph) ph.style.display='none'; });
  on('input[name="mode"][value="phased"]','change',()=>{ const ph=$('#phasedCard'); if(ph) ph.style.display='block'; if(phaseList.length===0) addPhase(); });
  on('#addPhase','click', addPhase);
  on('#resetPhases','click', initPh);
  on('#build','click', ()=>buildCashflows());
  on('#calc','click', ()=>{ const cfs= buildCashflows(); const disc=(parseFloat($('#disc').value)||0)/100; cfs[0]=parseFloat($('#budget').value||0); const r=IRR(cfs); const pb=payback(cfs); const npv=NPV(disc,cfs); const irrEl=$('#irr'); if(irrEl){ irrEl.textContent = isFinite(r)? pct(r): 'No valid IRR'; irrEl.className='val '+(isFinite(r)&&r>=0? 'good':'bad'); } const hurdle=(parseFloat($('#hurdle').value)||0)/100; const lamp=$('#lamp'), lampText=$('#lampText'); if(lamp){ if(isFinite(r)){ const pass=r>=hurdle; lamp.style.display='inline-flex'; lamp.className='lamp '+(pass? 'pass':'fail'); if(lampText) lampText.textContent= pass? 'Meets hurdle':'Below hurdle'; } else { lamp.style.display='none'; } } const pbEl=$('#pb'), pbM=$('#pbMonths'); if(pb.yrs===Infinity){ if(pbEl) pbEl.textContent='Not recovered'; if(pbM) pbM.textContent=''; } else { if(pbEl) pbEl.textContent=pb.yrs.toFixed(2)+' yrs'; if(pbM) pbM.textContent='('+pb.mos+' months)'; } const npvEl=$('#npv'); if(npvEl){ npvEl.textContent = fmt(npv)+' '+($('#cur')?.value||''); npvEl.className='val '+(npv>0? 'good':'bad'); } const warn=$('#warn'); if(warn){ warn.style.display='none'; warn.textContent=''; const hasPos=cfs.some(v=>v>0), hasNeg=cfs.some(v=>v<0); if(!(hasPos&&hasNeg)){ warn.style.display='block'; warn.textContent='Cashflows lack sign change ‚Äî IRR may be undefined.'; } }
  });
  on('#toggleWizard','click',()=>{ const w=$('#wizard'); if(!w) return; w.style.display = (w.style.display==='none'||!w.style.display)?'block':'none'; });
  ['#w_hours','#w_hourRate','#w_inc_events','#w_inc_minCost','#w_energy','#w_other','#w_opex'].forEach(sel=>{ const el=$(sel); if(el){ el.addEventListener('input', recomputeWizard); }});
  on('#applyWizard','click',()=>{ const net=+($('#w_net')?.value||0); if(isFinite(net)){ const b=$('#benefit'); if(b) b.value=Math.round(net); }});
  on('#loadSample','click',()=>{ const set=(id,v)=>{ const el=$(id); if(el) el.value=v; }; set('#w_hours',6500); set('#w_hourRate',346); set('#w_inc_events',24); set('#w_inc_minCost',8000); set('#w_energy',0); set('#w_other',0); set('#w_opex',250000); recomputeWizard(); });
  on('#exportCsv','click',()=>{ const cur=$('#cur')?.value||''; const years=parseInt($('#years')?.value||6); const cfs=buildCashflows(); cfs[0]=parseFloat($('#budget')?.value||0); let cum=0; const rows=[["Year","Cash Flow ("+cur+")","Cumulative ("+cur+")"]]; rows.push(['Y0', cfs[0], cum]); for(let y=1;y<=years;y++){ cum+=cfs[y]; rows.push(['Y'+y, Math.round(cfs[y]), Math.round(cum)]); } const meta=[["Currency",cur],["Horizon (yrs)",$('#years')?.value],["Budget", $('#budget')?.value],["Exec length", ($('#durVal')?.value||'')+' '+($('#durUnit')?.value||'')],["Benefit/yr", $('#benefit')?.value],["Discount %", $('#disc')?.value],["IRR hurdle %", $('#hurdle')?.value]]; const csv=buildCsvString(meta,rows); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='feasibility_cashflows.csv'; a.click(); URL.revokeObjectURL(url); });
  on('#exportPng','click',()=>{ const url=snapshotDataURL(); const a=document.createElement('a'); a.href=url; a.download='feasibility_kpis.png'; a.click(); });
  on('#runTests','click', runTests);
}

function recomputeWizard(){ const hours=+($('#w_hours')?.value||0); const rate=+($('#w_hourRate')?.value||0); const incN=+($('#w_inc_events')?.value||0); const incMinCost=+($('#w_inc_minCost')?.value||0); const energy=+($('#w_energy')?.value||0); const other=+($('#w_other')?.value||0); const opex=+($('#w_opex')?.value||0); const w1=hours*rate; const w2=incN*incMinCost; const w3=energy+other; const gross=w1+w2+w3; const net=gross-opex; const set=(id,val)=>{ const el=$(id); if(el) el.value=Math.round(val); }; set('#w_hours_sum',w1); set('#w_inc_sum',w2); set('#w_dir_sum',w3); set('#w_gross',gross); set('#w_net',net); const note=$('#wizardNote'); if(note) note.textContent = isFinite(net)? '‚Üí Net benefit = '+fmt(net)+' '+(($('#cur')?.value)||'')+'/yr' : ''; }

function approxEqual(a,b,eps){ return Math.abs(a-b) <= (eps||1e-6); }
function runTests(){ const out=[];
  // Existing tests (kept)
  let cfs=[-1000000, 400000, 400000, 400000, 400000]; let r=IRR(cfs); let npvAtR=NPV(r,cfs);
  out.push(`[IRR] exists & NPV(IRR)‚âà0: r=${(isFinite(r)?(r*100).toFixed(2)+'%':'NaN')} ‚Üí ` + (Math.abs(npvAtR) < 1e-3 ? 'PASS' : 'FAIL'));
  cfs=[-100, 40, 40, 40]; let pb=payback(cfs); out.push(`[Payback] ~2.5 yrs (30 mos): got ${(pb.yrs).toFixed(2)} yrs / ${pb.mos} mos ‚Üí ` + (Math.abs(pb.mos-30)<=1 ? 'PASS':'FAIL'));
  cfs=[0, 10, 20, 30]; r=IRR(cfs); out.push(`[IRR] undefined when no negative flows: ${isNaN(r)?'PASS':'FAIL'}`);
  const meta=[["Currency",'SAR'],["Horizon (yrs)",5]]; const rows=[["Year","Cash Flow (SAR)","Cumulative (SAR)"],["Y0",-1000,0],["Y1",300,300]]; const csv=buildCsvString(meta,rows); const okHdr = csv.indexOf('# Parameters\n')===0; const okSec = csv.includes('\n# Cashflows\n'); out.push(`[CSV] headers & sections present: ${(okHdr&&okSec)?'PASS':'FAIL'}`);
  try{ const url=snapshotDataURL(); out.push(`[PNG] data URL prefix: ${url.startsWith('data:image/png')?'PASS':'FAIL'}`);}catch(e){ out.push(`[PNG] threw error: FAIL ‚Üí ${e.message}`); }

  // Additional tests (added)
  // 6) Cashflows vector length equals years+1 for current inputs
  const yearsNow=parseInt($('#years')?.value||6); const c2=buildCashflows(); out.push(`[Build] cashflows length = years+1 (${yearsNow+1}): ${c2.length===yearsNow+1?'PASS':'FAIL'}`);
  // 7) CSV quoting when value contains comma and quote
  const csv2=buildCsvString([["Key",'He said, "Hi"']], [["Year","CF"],["Y0",-1]]);
  const quotedOK = /# Parameters\nKey,"He said, ""Hi"""\n/.test(csv2);
  out.push(`[CSV] quoting comma+quote: ${quotedOK?'PASS':'FAIL'}`);
  // 8) Payback immediate recovery at Y1
  const pb2=payback([-50, 60, 0]); out.push(`[Payback] immediate (<1 yr): ${pb2.mos<=12?'PASS':'FAIL'}`);
  // 9) IRR undefined when all flows negative
  const rNegOnly = IRR([-10,-20,-30]); out.push(`[IRR] undefined for all-negative flows: ${isNaN(rNegOnly)?'PASS':'FAIL'}`);
  // 10) Payback Infinity when never recovers
  const pbNever = payback([-100, 10, 10, 10]); out.push(`[Payback] not recovered ‚Üí Infinity: ${(pbNever.mos===Infinity && pbNever.yrs===Infinity)?'PASS':'FAIL'}`);

  const outBox=$('#testOut'); if(outBox) outBox.textContent=out.join('\n'); }

function init(){ try{ bindUI(); initPh(); } catch(e){ showErr(e.message||String(e)); } }

if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
</script>

</body>
</html>
